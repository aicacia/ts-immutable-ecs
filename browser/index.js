import{Record as e,OrderedSet as t,Map as s,List as r}from"https://unpkg.com/immutable@4/dist/immutable.es.js";class o extends(e({children:t()},"ecs.hierarchy.Children")){static toString(){return o.displayName}}class n extends(e({entity:null},"ecs.hierarchy.Parent")){static toString(){return n.displayName}}class i extends(e({entity:null},"ecs.hierarchy.PreviousParent")){static toString(){return i.displayName}}const c=e=>t=>u(t,e);function u(e,t){const s=e.getComponent(t,o);if(s){for(const t of s.children)e=(e=u(e,t)).deleteComponent(t,n);e=e.deleteComponent(t,o)}return e}let d=0;class a{constructor(e){this.id=e||d++}getId(){return this.id}toString(){return this.id}}class h extends(e({resources:t(),resourcesToDelete:t(),resourcesToUpdate:t(),changed:t(),deleted:t()},"ecs.ResourceManager")){setResource(e){return this.set("resourcesToUpdate",this.resourcesToUpdate.add(e))}addResource(e){return this.setResource(e)}updateResource(e,t){return this.setResource(t(e))}deleteResource(e){return this.resources.has(e)?this.set("resourcesToDelete",this.resourcesToDelete.add(e)):this}getResource(e){return this.resources.has(e)?e:void 0}getChangedResource(e){return this.changed.has(e)?e:void 0}changedResource(e){return this.changed.has(e)}getDeletedResource(e){return this.deleted.has(e)?e:void 0}deletedResource(e){return this.deleted.has(e)}isEmpty(){return 0===this.resources.size}keys(){return this.resources.keys()}values(){return this.resources.values()}entries(){return this.resources.entries()}maintain(){let e=this;for(const t of e.resourcesToDelete)e=e.set("resources",e.resources.delete(t));e=e.set("deleted",e.resourcesToDelete),e=e.set("resourcesToDelete",e.resourcesToDelete.clear());for(const t of e.resourcesToUpdate)e=e.set("resources",e.resources.add(t));return e=e.set("changed",e.resourcesToUpdate),e=e.set("resourcesToUpdate",e.resourcesToUpdate.clear()),e}}class l extends(e({resources:s(),resourcesToDelete:s(),resourcesToUpdate:s(),changed:s(),deleted:s()},"ecs.ResourceClassManager")){setResource(e,t){return this.set("resourcesToUpdate",this.resourcesToUpdate.set(e,t))}addResource(e){return this.setResource(Object.getPrototypeOf(e).constructor,e)}updateResource(e,t){const s=this.getResource(e);return s?this.set("resourcesToUpdate",this.resourcesToUpdate.set(e,t(s))):this}deleteResource(e){const t=this.getResource(e);return t?this.set("resourcesToDelete",this.resourcesToDelete.set(e,t)):this}getResource(e){return this.resources.get(e)}hasResource(e){return this.resources.has(e)}getChangedResource(e){return this.changed.get(e)}changedResource(e){return this.changed.has(e)}getDeletedResource(e){return this.deleted.get(e)}deletedResource(e){return this.deleted.has(e)}isEmpty(){return 0===this.resources.size}keys(){return this.resources.keys()}values(){return this.resources.values()}entries(){return this.resources.entries()}maintain(){let e=this;for(const t of e.resourcesToDelete.keys())e=e.set("resources",e.resources.delete(t));e=e.set("deleted",e.resourcesToDelete),e=e.set("resourcesToDelete",e.resourcesToDelete.clear());for(const[t,s]of e.resourcesToUpdate)e=e.set("resources",e.resources.set(t,s));return e=e.set("changed",e.resourcesToUpdate),e=e.set("resourcesToUpdate",e.resourcesToUpdate.clear()),e}}const m=e=>e;class p{constructor(e,t){this.world=e.addEntity(t),this.entity=t}withComponent(e){return this.world=this.world.addComponent(this.entity,e),this}addComponent(e){return this.world=this.world.addComponent(this.entity,e),this}withChild(e=m){const t=new a;this.world=this.world.addEntity(t),this.world=this.world.addComponent(t,new n({entity:this.entity}));const[s,r]=e(new p(this.world,t)).build();return this.world=s,this}addChild(e){return this.world=this.world.addComponent(e,new n({entity:this.entity})),this}build(){return[this.world,this.entity]}}function f(e){return{changed:e}}function g(e){return{without:e}}function y(e){return{optional:e}}function R(e){return{oneOf:e}}function w(e,t,s){return C(e,t,s)}function C(e,t,s){if(Array.isArray(s)){const r=[];for(const o of s){const s=C(e,t,o);if(void 0===s)return;r.push(s)}return r}if("changed"in s)return t.changedResource(s.changed);if(function(e){return"deleted"in e}(s))return t.deletedResource(s.deleted);if(function(e){return"without"in e}(s))return t.hasResource(s.without)?void 0:null;if(function(e){return"optional"in e}(s))return t.getResource(s.optional);if(!function(e){return"oneOf"in e}(s))return s===a?e:t.getResource(s);for(const r of s.oneOf){const s=C(e,t,r);if(void 0!==s)return s}}var T;!function(e){e[e.First=0]="First",e[e.PreUpdate=1]="PreUpdate",e[e.Update=2]="Update",e[e.PostUpdate=3]="PostUpdate",e[e.Last=4]="Last"}(T||(T={}));class U extends(e({entities:new h,components:s(),resources:new l,systems:r(),commands:r()},"ecs.World")){addPlugin(e){return this.addPlugins(e)}addPlugins(...e){return e.reduce(((e,t)=>t(e)),this)}addSystemAtStage(e,t){let s=this.systems.get(e);return s||(s=new h),this.set("systems",this.systems.set(e,s.addResource(t)))}addSystem(e){return this.addSystemAtStage(T.Update,e)}deleteSystemAtStage(e,t){const s=this.systems.get(e);return s?this.set("systems",this.systems.set(e,s.deleteResource(t))):this}deleteSystem(e){return this.deleteSystemAtStage(T.Update,e)}addResource(e){return this.set("resources",this.resources.addResource(e))}setResource(e,t){return this.set("resources",this.resources.setResource(e,t))}deleteResource(e){return this.set("resources",this.resources.deleteResource(e))}getResource(e){return this.resources.getResource(e)}updateResource(e,t){return this.set("resources",this.resources.updateResource(e,t))}addComponent(e,t){let s=this.components.get(e);return s||(s=new l),this.set("components",this.components.set(e,s.addResource(t)))}deleteComponent(e,t){const s=this.components.get(e);if(s){const r=s.deleteResource(t);return r.isEmpty()?this.set("components",this.components.delete(e)):this.set("components",this.components.set(e,r))}return this}getComponent(e,t){const s=this.components.get(e);return s?s.getResource(t):void 0}updateComponent(e,t,s){const r=this.components.get(e);return r?this.set("components",this.components.set(e,r.updateResource(t,s))):this}setComponent(e,t,s){const r=this.components.get(e);return r?this.set("components",this.components.set(e,r.setResource(t,s))):this}withEntity(e){const[t,s]=e(new p(this,new a)).build();return t.set("entities",t.entities.addResource(s))}addEntity(e){return this.set("entities",this.entities.addResource(e))}deleteEntity(e){return this.set("entities",this.entities.deleteResource(e))}runCommandAtStage(e,t){let s=this.commands.get(e);return s||(s=r()),this.set("commands",this.commands.set(e,s.push(t)))}runCommand(e){return this.runCommandAtStage(T.Update,e),this}update(){let e=this;e=e.maintain();for(const t of e.systems)if(t)for(const s of t.values())e=s(e);for(const t of e.commands)if(t)for(const s of t.values())e=s(e);return e=e.set("commands",e.commands.clear()),e}maintain(){let e=this;for(const[t,s]of e.components){const r=s.maintain();e=r.isEmpty()?e.set("components",e.components.delete(t)):e.set("components",e.components.set(t,r))}e=e.set("entities",e.entities.maintain()),e=e.set("resources",e.resources.maintain());for(const[t,s]of e.systems.entries()){if(!s)continue;const r=s.maintain();e=r.isEmpty()?e.set("systems",e.systems.delete(t)):e.set("systems",e.systems.set(t,r))}return e}*query(...e){for(const[t,s]of this.components.entries()){const r=w(t,s,e);void 0!==r&&(yield r)}}queryOne(e,...t){const s=this.components.get(t[0]);return s?w(e,s,t):void 0}}function S(e){for(const[t,s]of e.query(a,i,g(n)))e=(e=e.updateComponent(s.entity,o,(e=>e.set("children",e.children.delete(t))))).deleteComponent(t,i);const s=new Map;for(const[t,r,c]of e.query(a,n,y(i))){const n=r.entity;if(c){const s=c.entity;if(s===n)continue;e=(e=e.updateComponent(s,o,(e=>e.set("children",e.children.delete(t))))).updateComponent(t,i,(e=>e.set("entity",n)))}else e=e.addComponent(t,new i({entity:n}));const u=e.getComponent(n,o);if(u)u.children.includes(t)||(e=e.updateComponent(n,o,(e=>e.set("children",e.children.add(t)))));else{const e=s.get(n);e?e.push(t):s.set(n,[t])}}for(const[r,n]of s)e=e.addComponent(r,new o({children:t(n)}));return e}const v=()=>e=>e.runCommandAtStage(T.First,S).addSystemAtStage(T.PostUpdate,S);export{o as Children,T as CoreStage,a as Entity,p as EntityBuilder,n as Parent,i as PreviousParent,l as ResourceClassManager,h as ResourceManager,U as World,f as changed,v as hierarchyPlugin,R as oneOf,y as optional,S as parentUpdateSystem,c as removeChildren,g as without};
//# sourceMappingURL=index.js.map
