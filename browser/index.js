import{Record as e,OrderedSet as t,Map as s,List as r}from"https://unpkg.com/immutable@4/dist/immutable.es.js";import{vec2 as n,mat4 as o,mat2d as i,vec3 as c,quat as u}from"https://unpkg.com/gl-matrix@3/esm/index.js";class a extends(e({children:t()},"ecs.hierarchy.Children")){static toString(){return a.displayName}}class d extends(e({entity:null},"ecs.hierarchy.Parent")){static toString(){return d.displayName}}class h extends(e({entity:null},"ecs.hierarchy.PreviousParent")){static toString(){return h.displayName}}const l=e=>t=>m(t,e);function m(e,t){const s=e.getComponent(t,a);if(s){for(const t of s.children)e=(e=m(e,t)).deleteComponent(t,d);e=e.deleteComponent(t,a)}return e}let p=0;class f{constructor(e){this.id=null==e?p++:e}getId(){return this.id}toString(){return this.id}}class g extends(e({resources:t(),resourcesToDelete:t(),resourcesToUpdate:t(),changed:t(),deleted:t()},"ecs.ResourceManager")){setResource(e){return this.set("resourcesToUpdate",this.resourcesToUpdate.add(e))}addResource(e){return this.setResource(e)}updateResource(e,t){return this.setResource(t(e))}deleteResource(e){return this.resources.has(e)?this.set("resourcesToDelete",this.resourcesToDelete.add(e)):this}getResource(e){return this.resources.has(e)?e:void 0}getChangedResource(e){return this.changed.has(e)?e:void 0}changedResource(e){return this.changed.has(e)}getDeletedResource(e){return this.deleted.has(e)?e:void 0}deletedResource(e){return this.deleted.has(e)}isEmpty(){return 0===this.resources.size}keys(){return this.resources.keys()}values(){return this.resources.values()}entries(){return this.resources.entries()}maintain(){let e=this;for(const t of e.resourcesToDelete)e=e.set("resources",e.resources.delete(t));e=e.set("deleted",e.resourcesToDelete),e=e.set("resourcesToDelete",e.resourcesToDelete.clear());for(const t of e.resourcesToUpdate)e=e.set("resources",e.resources.add(t));return e=e.set("changed",e.resourcesToUpdate),e=e.set("resourcesToUpdate",e.resourcesToUpdate.clear()),e}}class y extends(e({resources:s(),resourcesToDelete:s(),resourcesToUpdate:s(),changed:s(),deleted:s()},"ecs.ResourceClassManager")){setResource(e,t){return this.set("resourcesToUpdate",this.resourcesToUpdate.set(e,t))}addResource(e){return this.setResource(Object.getPrototypeOf(e).constructor,e)}updateResource(e,t){const s=this.getResource(e);return s?this.set("resourcesToUpdate",this.resourcesToUpdate.set(e,t(s))):this}deleteResource(e){const t=this.getResource(e);return t?this.set("resourcesToDelete",this.resourcesToDelete.set(e,t)):this}getResource(e){return this.resources.get(e)}hasResource(e){return this.resources.has(e)}getChangedResource(e){return this.changed.get(e)}changedResource(e){return this.changed.has(e)}getDeletedResource(e){return this.deleted.get(e)}deletedResource(e){return this.deleted.has(e)}isEmpty(){return 0===this.resources.size}keys(){return this.resources.keys()}values(){return this.resources.values()}entries(){return this.resources.entries()}maintain(){let e=this;for(const t of e.resourcesToDelete.keys())e=e.set("resources",e.resources.delete(t));e=e.set("deleted",e.resourcesToDelete),e=e.set("resourcesToDelete",e.resourcesToDelete.clear());for(const[t,s]of e.resourcesToUpdate)e=e.set("resources",e.resources.set(t,s));return e=e.set("changed",e.resourcesToUpdate),e=e.set("resourcesToUpdate",e.resourcesToUpdate.clear()),e}}const x=e=>e;class R{constructor(e,t){this.world=e.addEntity(t),this.entity=t}withComponent(e){return this.world=this.world.addComponent(this.entity,e),this}addComponent(e){return this.world=this.world.addComponent(this.entity,e),this}withChild(e=x){const t=new f;this.world=this.world.addEntity(t),this.world=this.world.addComponent(t,new d({entity:this.entity}));const[s,r]=e(new R(this.world,t)).build();return this.world=s,this}addChild(e){return this.world=this.world.addComponent(e,new d({entity:this.entity})),this}build(){return[this.world,this.entity]}}function w(e){return{changed:e}}function D(e){return{without:e}}function T(e){return{optional:e}}function C(...e){return{oneOf:e}}function M(e,t,s){return S(e,t,s)}function S(e,t,s){if(Array.isArray(s)){const r=[];for(const n of s){const s=S(e,t,n);if(void 0===s)return;r.push(s)}return r}if("changed"in s)return t.changedResource(s.changed);if(function(e){return"deleted"in e}(s))return t.deletedResource(s.deleted);if(function(e){return"without"in e}(s))return t.hasResource(s.without)?void 0:null;if(function(e){return"optional"in e}(s))return t.getResource(s.optional);if(!function(e){return"oneOf"in e}(s))return s===f?e:t.getResource(s);for(const r of s.oneOf){const s=S(e,t,r);if(void 0!==s)return s}}var U;!function(e){e[e.First=0]="First",e[e.PreUpdate=1]="PreUpdate",e[e.Update=2]="Update",e[e.PostUpdate=3]="PostUpdate",e[e.Last=4]="Last"}(U||(U={}));class v extends(e({entities:new g,components:s(),resources:new y,systems:r(),commands:r()},"ecs.World")){addPlugin(e){return this.addPlugins(e)}addPlugins(...e){return e.reduce(((e,t)=>t(e)),this)}addSystemAtStage(e,t){let s=this.systems.get(e);return s||(s=new g),this.set("systems",this.systems.set(e,s.addResource(t)))}addSystem(e){return this.addSystemAtStage(U.Update,e)}deleteSystemAtStage(e,t){const s=this.systems.get(e);return s?this.set("systems",this.systems.set(e,s.deleteResource(t))):this}deleteSystem(e){return this.deleteSystemAtStage(U.Update,e)}addResource(e){return this.set("resources",this.resources.addResource(e))}setResource(e,t){return this.set("resources",this.resources.setResource(e,t))}deleteResource(e){return this.set("resources",this.resources.deleteResource(e))}getResource(e){return this.resources.getResource(e)}updateResource(e,t){return this.set("resources",this.resources.updateResource(e,t))}addComponent(e,t){let s=this.components.get(e);return s||(s=new y),this.set("components",this.components.set(e,s.addResource(t)))}deleteComponent(e,t){const s=this.components.get(e);if(s){const r=s.deleteResource(t);return r.isEmpty()?this.set("components",this.components.delete(e)):this.set("components",this.components.set(e,r))}return this}getComponent(e,t){const s=this.components.get(e);return s?s.getResource(t):void 0}updateComponent(e,t,s){const r=this.components.get(e);return r?this.set("components",this.components.set(e,r.updateResource(t,s))):this}setComponent(e,t,s){const r=this.components.get(e);return r?this.set("components",this.components.set(e,r.setResource(t,s))):this}withEntity(e){const[t,s]=e(new R(this,new f)).build();return t.set("entities",t.entities.addResource(s))}addEntity(e){return this.set("entities",this.entities.addResource(e))}deleteEntity(e){return this.set("entities",this.entities.deleteResource(e))}runCommandAtStage(e,t){let s=this.commands.get(e);return s||(s=r()),this.set("commands",this.commands.set(e,s.push(t)))}runCommand(e){return this.runCommandAtStage(U.Update,e),this}update(){let e=this;e=e.maintain();for(const t of e.systems)if(t)for(const s of t.values())e=s(e);for(const t of e.commands)if(t)for(const s of t.values())e=s(e);return e=e.set("commands",e.commands.clear()),e}maintain(){let e=this;for(const[t,s]of e.components){const r=s.maintain();e=r.isEmpty()?e.set("components",e.components.delete(t)):e.set("components",e.components.set(t,r))}e=e.set("entities",e.entities.maintain()),e=e.set("resources",e.resources.maintain());for(const[t,s]of e.systems.entries()){if(!s)continue;const r=s.maintain();e=r.isEmpty()?e.set("systems",e.systems.delete(t)):e.set("systems",e.systems.set(t,r))}return e}*query(...e){for(const[t,s]of this.components.entries()){const r=M(t,s,e);void 0!==r&&(yield r)}}queryOne(e,...t){const s=this.components.get(e);return s?M(e,s,t):void 0}}function b(e){for(const[t,s]of e.query(f,h,D(d)))e=(e=e.updateComponent(s.entity,a,(e=>e.set("children",e.children.delete(t))))).deleteComponent(t,h);const s=new Map;for(const[t,r,n]of e.query(f,d,T(h))){const o=r.entity;if(n){const s=n.entity;if(s===o)continue;e=(e=e.updateComponent(s,a,(e=>e.set("children",e.children.delete(t))))).updateComponent(t,h,(e=>e.set("entity",o)))}else e=e.addComponent(t,new h({entity:o}));const i=e.getComponent(o,a);if(i)i.children.includes(t)||(e=e.updateComponent(o,a,(e=>e.set("children",e.children.add(t)))));else{const e=s.get(o);e?e.push(t):s.set(o,[t])}}for(const[r,n]of s)e=e.addComponent(r,new a({children:t(n)}));return e}const q=()=>e=>e.runCommandAtStage(U.First,b).addSystemAtStage(U.PostUpdate,b);var A="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},P={},E={get exports(){return P},set exports(e){P=e}},k={},F={get exports(){return k},set exports(e){k=e}};(function(){var e,t,s,r,n,o;"undefined"!=typeof performance&&null!==performance&&performance.now?F.exports=function(){return performance.now()}:"undefined"!=typeof process&&null!==process&&process.hrtime?(F.exports=function(){return(e()-n)/1e6},t=process.hrtime,r=(e=function(){var e;return 1e9*(e=t())[0]+e[1]})(),o=1e9*process.uptime(),n=r-o):Date.now?(F.exports=function(){return Date.now()-s},s=Date.now()):(F.exports=function(){return(new Date).getTime()-s},s=(new Date).getTime())}).call(A);for(var O=k,N="undefined"==typeof window?A:window,j=["moz","webkit"],z="AnimationFrame",G=N["request"+z],L=N["cancel"+z]||N["cancelRequest"+z],V=0;!G&&V<j.length;V++)G=N[j[V]+"Request"+z],L=N[j[V]+"Cancel"+z]||N[j[V]+"CancelRequest"+z];if(!G||!L){var I=0,W=0,B=[];G=function(e){if(0===B.length){var t=O(),s=Math.max(0,16.666666666666668-(t-I));I=s+t,setTimeout((function(){var e=B.slice(0);B.length=0;for(var t=0;t<e.length;t++)if(!e[t].cancelled)try{e[t].callback(I)}catch(e){setTimeout((function(){throw e}),0)}}),Math.round(s))}return B.push({handle:++W,callback:e,cancelled:!1}),W},L=function(e){for(var t=0;t<B.length;t++)B[t].handle===e&&(B[t].cancelled=!0)}}E.exports=function(e){return G.call(N,e)},P.cancel=function(){L.apply(N,arguments)},P.polyfill=function(e){e||(e=N),e.requestAnimationFrame=G,e.cancelAnimationFrame=L};class H{constructor(e){this.id=null,this.running=!1,this.start=()=>{this.running||(this.running=!0,this.request())},this.run=e=>(this.updateFn(e),this.running&&this.request(),this),this.updateFn=e}stop(){return this.running=!1,null!==this.id&&(P.cancel(this.id),this.id=null),this}isStopped(){return!1===this.running}request(){return this.id=P(this.run),this}}function J(e,t){return o.set(e,t[0],t[1],0,t[4],t[2],t[3],0,t[5],0,0,1,0,0,0,0,1)}function K(e,t){return i.set(e,t[0],t[1],t[4],t[5],t[13],t[14])}n.create(),n.create();const Q=i.create(),X=o.create();class Y extends(e({position:n.create(),scale:n.fromValues(1,1),rotation:0},"ecs.transform.Transform2D")){static toString(){return Y.displayName}is2D(){return!0}is3D(){return!1}getMatrix2D(e){return function(e,t,s,r){const n=s[0],o=s[1],i=Math.cos(r),c=Math.sin(r);return e[0]=i*n,e[1]=c*n,e[2]=-c*o,e[3]=i*o,e[4]=t[0],e[5]=t[1],e}(e,this.position,this.scale,this.rotation)}getMatrix(e){return J(e,this.getMatrix2D(Q))}}class Z extends(e({position:c.create(),scale:c.fromValues(1,1,1),rotation:u.create()},"ecs.transform.Transform3D")){static toString(){return Z.displayName}is2D(){return!1}is3D(){return!0}getMatrix2D(e){return K(e,this.getMatrix(X))}getMatrix(e){return o.fromRotationTranslationScale(e,this.rotation,this.position,this.scale)}}class $ extends(e({matrix:i.create()},"ecs.transform.GlobalTransform2D")){static toString(){return $.displayName}is2D(){return!0}is3D(){return!1}setMatrix(e){return this.set("matrix",e)}getMatrix2D(e){return i.copy(e,this.matrix)}getMatrix(e){return J(e,this.getMatrix2D(Q))}}class _ extends(e({matrix:o.create()},"ecs.transform.GlobalTransform3D")){static toString(){return _.displayName}is2D(){return!1}is3D(){return!0}setMatrix(e){return this.set("matrix",e)}getMatrix2D(e){return K(e,this.matrix)}getMatrix(e){return o.copy(e,this.matrix)}}function ee(e){for(const[t,s,r]of e.query(f,Z,_,D(d),D(a)))e=e.setComponent(t,_,r.set("matrix",s.getMatrix(r.matrix)));for(const[t,s,r]of e.query(f,Y,$,D(d),D(a)))e=e.setComponent(t,$,r.set("matrix",s.getMatrix2D(r.matrix)));return e}const te=i.create(),se=i.create(),re=o.create(),ne=o.create();function oe(e){for(const[t,s,r,n,c,u,h]of e.query(f,C(Y,Z),a,w(Y),w(Z),w(a),C($,_),D(d))){(n||c)&&(e=h.is3D()?e.updateComponent(t,_,(e=>e.setMatrix(s.getMatrix(o.create())))):e.updateComponent(t,$,(e=>e.setMatrix(s.getMatrix2D(i.create())))));const a=n||c||u;for(const s of r.children)e=ie(e,t,h,s,a)}return e}function ie(e,t,s,r,n){const c=e.getComponent(r,d);if(!c||c.entity!==t)throw new Error("Malformed hierarchy. This probably means that your hierarchy has been improperly maintained, or contains a cycle");let u;const h=e.queryOne(r,C(Y,Z),w(Y),w(Z),C($,_));if(!h)return e;{const[t,c,a,d]=h;c||a||n?d.is3D()?(u=d.setMatrix(o.mul(d.matrix,s.getMatrix(re),t.getMatrix(ne))),e=e.setComponent(r,_,u)):(u=d.setMatrix(i.mul(d.matrix,s.getMatrix2D(te),t.getMatrix2D(se))),e=e.setComponent(r,$,u)):u=d}const l=e.queryOne(r,a,w(a),d,C($,_));if(l){const[t,s]=l,o=s||n;for(const s of t.children)e=ie(e,r,u,s,o)}return e}const ce=()=>e=>e.addSystemAtStage(U.PreUpdate,ee).addSystemAtStage(U.PreUpdate,oe);export{a as Children,U as CoreStage,f as Entity,R as EntityBuilder,_ as GlobalTransform3D,H as Loop,d as Parent,h as PreviousParent,y as ResourceClassManager,g as ResourceManager,Z as Transform3D,v as World,w as changed,q as hierarchyPlugin,C as oneOf,T as optional,b as parentUpdateSystem,l as removeChildren,ce as transformPlugin,oe as transformSystem,D as without};
//# sourceMappingURL=index.js.map
